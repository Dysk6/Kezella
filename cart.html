<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Your Bag | Kezeélla</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <link rel="icon" type="image/png" href="favicon.png">
  <link rel="stylesheet" href="css/style.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  
  <script src="https://js.paystack.co/v1/inline.js"></script>
</head>
<body>

<header class="header">
  <div class="logo">Kezeélla</div>
  <nav class="nav">
    <a href="shop.html" class="nav-link">Shop</a>
    <a href="index.html" class="nav-link">Home</a>
    <a href="cart.html" class="cart-link">
      <i class="fas fa-bag-shopping"></i>
      <span id="cartCount">0</span>
    </a>
  </nav>
</header>

<div class="cart-container">
  <h1 style="text-align: center; letter-spacing: 4px; margin-bottom: 40px; text-transform: uppercase;">Shopping Bag</h1>

  <div class="checkout-grid">
 
    <div class="cart-items-section">
      <div id="cartItemsWrapper">
        </div>
      <p id="emptyMsg" style="text-align: center; color: #888; display: none;">Your bag is empty.</p>
    </div>

    <div class="checkout-form-section" style="background: #111; padding: 30px; border: 1px solid #222; height: fit-content;">
  <h3 style="color: gold; text-transform: uppercase; letter-spacing: 2px; margin-bottom: 20px;">Shipping Details</h3>
  
  <form id="paymentForm">
    <div style="margin-bottom: 15px;">
      <label class="field-label">Full Name</label>
      <input type="text" id="fullName" placeholder="Enter your name" required class="dark-input">
    </div>

    <div style="margin-bottom: 15px;">
      <label class="field-label">Email Address</label>
      <input type="email" id="email" placeholder="Enter your email" required class="dark-input">
    </div>
    
    <div style="margin-bottom: 15px;">
      <label class="field-label">Phone Number</label>
      <input type="tel" id="phone" placeholder="080..." required class="dark-input">
    </div>

    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
      <div>
        <label class="field-label">State</label>
        <input type="text" id="state" placeholder="e.g. Abuja" required class="dark-input">
      </div>
      <div>
        <label class="field-label">LGA</label>
        <input type="text" id="city" placeholder="e.g. Bwari LGA" required class="dark-input">
      </div>
    </div>

    <div style="margin-bottom: 15px;">
      <label class="field-label">Town</label>
      <input type="text" id="town" placeholder="e.g. Kubwa" required class="dark-input">
    </div>

    <div style="margin-bottom: 15px;">
      <label class="field-label">Add Comment</label>
      <input type="text" id="addComment" placeholder="e.g. Colour Note" required class="dark-input">
    </div>

    <div style="margin-bottom: 20px;">
      <label class="field-label">Delivery Region</label>
      <select id="locationSelect" onchange="calculateTotal()" class="dark-input" style="cursor: pointer;">
        <option value="nigeria">Within Nigeria (₦6,000)</option>
        <option value="international">Outside Nigeria (Contact Us)</option>
      </select>
    </div>

    <hr style="border: 0; border-top: 1px solid #333; margin: 20px 0;">

    <div class="total-row">
      <span>Subtotal</span>
      <span id="subtotalDisplay">₦0</span>
    </div>
    <div class="total-row">
      <span>Shipping</span>
      <span id="shippingDisplay">₦6,000</span>
    </div>
    <div class="total-row main-total">
      <span>TOTAL</span>
      <span id="totalDisplay">₦0</span>
    </div>

    <button type="button" id="payBtn" class="checkout-btn">Proceed to Payment</button>
  </form>
</div>

<style>
  .field-label {
    display: block; 
    font-size: 10px; 
    color: #888; 
    text-transform: uppercase; 
    margin-bottom: 5px;
    letter-spacing: 1px;
  }
  .dark-input {
    width: 100%; 
    padding: 12px; 
    background: #000; 
    border: 1px solid #333; 
    color: white;
    font-size: 14px;
  }
  .dark-input:focus {
    border-color: gold;
    outline: none;
  }
  .total-row {
    display: flex; 
    justify-content: space-between; 
    margin-bottom: 10px; 
    font-size: 14px;
    color: #aaa;
  }
  .main-total {
    margin-top: 20px; 
    font-size: 18px; 
    color: gold; 
    font-weight: bold;
  }
</style>

<footer id="contact" class="footer">
  <div class="footer-container">
    
    <div class="footer-section">
      <h3>Contact Kezeélla</h3>
      <a href="mailto:kezeella.store@gmail.com" class="email-link">
        <i class="fas fa-envelope"></i> kezeella.store@gmail.com
      </a>
    </div>

    <div class="footer-section">
      <h3>Follow Us On</h3>
      <div class="social-icons">
        <a href="https://www.threads.com/@kezeella?igshid=NTc4MTIwNjQ2YQ==" target="_blank" title="Threads">
          <i class="fa-brands fa-threads"></i>
        </a>
        <a href="https://www.instagram.com/kezeella?igsh=MXNlbG82ZG5ldTZ1MQ%3D%3D&utm_source=qr" target="_blank" title="Instagram">
          <i class="fa-brands fa-instagram"></i>
        </a>
        <a href="https://www.facebook.com/share/14VaV3Qz4aR/?mibextid=LQQJ4d" target="_blank" title="Facebook">
          <i class="fa-brands fa-facebook"></i>
        </a>
        <a href="https://www.tiktok.com/@kezeella" target="_blank" title="TikTok">
          <i class="fa-brands fa-tiktok"></i>
        </a>
      </div>
    </div>

  </div>

  <div class="footer-bottom">
    <p>© Kezeélla Luxury Fashion</p>
  </div>
</footer>

<script>
/* ================= CONFIG ================= */
const publicKey = "pk_live_abb659a5759ee7b6e6cbf9c0cfcb568e0d3584e8";
const shippingCost = 6000;
let cart = JSON.parse(localStorage.getItem("cart")) || [];

/* ================= PAYMENT CALLBACK ================= */
function paymentCallback(response) {
  alert("Payment successful! Reference: " + response.reference);

  fetch(`/api/verify?reference=${response.reference}`)
    .then(res => res.json())
    .then(result => {
      if (result.verified) {
        localStorage.removeItem("cart");
        window.location.href = "success.html?ref=" + response.reference;
      } else {
        alert("Payment verification failed.");
      }
    })
    .catch(() => alert("Verification error."));
}

/* ================= RENDER CART ================= */
function renderCart() {
  const wrapper = document.getElementById("cartItemsWrapper");
  const emptyMsg = document.getElementById("emptyMsg");
  const checkoutSection = document.querySelector(".checkout-form-section");

  if (!wrapper) return;

  wrapper.innerHTML = "";

  if (cart.length === 0) {
    emptyMsg.style.display = "block";
    checkoutSection.style.display = "none";
    return;
  }

  emptyMsg.style.display = "none";
  checkoutSection.style.display = "block";

  cart.forEach((item, index) => {
    wrapper.innerHTML += `
      <div class="cart-item" style="display:flex;gap:20px;border-bottom:1px solid #222;padding:20px 0;">
        <img src="${item.image}" style="width:80px;height:100px;object-fit:cover;">
        <div style="flex:1;">
          <h4 style="color:gold;text-transform:uppercase;">${item.name}</h4>
          <p style="font-size:12px;color:#888;">Size: ${item.size}</p>
          <p style="font-size:14px;margin-top:5px;">₦${item.price.toLocaleString()}</p>
          <button onclick="removeItem(${index})"
            style="background:none;border:none;color:#ff4444;font-size:11px;margin-top:10px;cursor:pointer;">
            REMOVE
          </button>
        </div>
      </div>
    `;
  });

  calculateTotal();
  updateGlobalCartCount();
}

function removeItem(index) {
  cart.splice(index, 1);
  localStorage.setItem("cart", JSON.stringify(cart));
  renderCart();
}

/* ================= TOTAL ================= */
function calculateTotal() {
  const subtotal = cart.reduce((sum, item) => sum + item.price, 0);
  const location = document.getElementById("locationSelect")?.value;
  const btn = document.getElementById("payBtn");

  document.getElementById("subtotalDisplay").innerText = "₦" + subtotal.toLocaleString();

  if (location === "nigeria") {
    const total = subtotal + shippingCost;
    document.getElementById("shippingDisplay").innerText = "₦" + shippingCost.toLocaleString();
    document.getElementById("totalDisplay").innerText = "₦" + total.toLocaleString();
    btn.innerText = "Pay Now (Secured by Paystack)";
  } else {
    document.getElementById("shippingDisplay").innerText = "TBD";
    document.getElementById("totalDisplay").innerText = "Inquire";
    btn.innerText = "Contact Us for International Invoice";
  }
}

/* ================= PAYSTACK ================= */
function payWithPaystack(e) {
  e.preventDefault();

  const email = document.getElementById("email")?.value.trim();
  const phone = document.getElementById("phone")?.value.trim();
  const name = document.getElementById("fullName")?.value.trim();
  const state = document.getElementById("state")?.value || "";
  const lga = document.getElementById("lga")?.value || "";
  const town = document.getElementById("town")?.value || "";
  const comment = document.getElementById("addComment")?.value || "";

  if (!email || !phone || !name) {
    alert("Please fill in all required details.");
    return;
  }

  const subtotal = cart.reduce((sum, item) => sum + item.price, 0);
  const total = subtotal + shippingCost;

  PaystackPop.setup({
    key: publicKey,
    email: email,
    amount: total * 100,
    currency: "NGN",
    ref: "" + Date.now(),

    metadata: {
      custom_fields: [
        { display_name: "Full Name", variable_name: "full_name", value: name },
        { display_name: "Phone", variable_name: "phone", value: phone },
        { display_name: "State", variable_name: "state", value: state },
        { display_name: "LGA", variable_name: "lga", value: lga },
        { display_name: "Town", variable_name: "town", value: town },
        { display_name: "Add Comment", variable_name: "add_comment", value: comment },
        { display_name: "Cart Items", variable_name: "cart_items", value: cart.map(i => `${i.name} | Size: ${i.size} | ₦${i.price}`).join(" || ") }
      ]
    },

    callback: paymentCallback,
    onClose: () => alert("Transaction was not completed.")
  }).openIframe();
}

/* ================= INIT ================= */
document.addEventListener("DOMContentLoaded", function () {
  renderCart();

  document.getElementById("payBtn")?.addEventListener("click", function (e) {
    const location = document.getElementById("locationSelect")?.value;
    if (location !== "nigeria") {
      alert("International orders handled manually.");
      return;
    }
    payWithPaystack(e);
  });
});

function updateGlobalCartCount() {
  const badge = document.getElementById("cartCount");
  if (badge) badge.innerText = cart.length;
}
</script>
